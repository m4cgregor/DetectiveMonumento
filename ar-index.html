<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detectives del Monumento - Web AR</title>

    <!-- MindAR + A-Frame Libraries -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0d1b2a;
            overflow: hidden;
        }

        /* AR Scene Container */
        #ar-scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none;
        }

        #ar-scene-container.active {
            display: block;
        }

        /* UI Overlay on AR */
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        .ar-overlay.active {
            display: block;
        }

        .ar-ui-top {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
            max-width: 90%;
        }

        .ar-ui-top h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .ar-ui-top p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .ar-detection-status {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(117, 170, 219, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .ar-detection-status.active {
            display: block;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.05);
            }
        }

        .ar-buttons {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: all;
        }

        .ar-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .ar-btn:active {
            transform: scale(0.95);
        }

        .ar-btn-primary {
            background: rgba(117, 170, 219, 0.9);
            border-color: #75AADB;
        }

        /* Regular UI Screens */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            z-index: 5;
            </p></div><button class="btn btn-gold" onclick="showScreen('screen-hub')">ACEPTAR MISI√ìN</button></div></div>< !-- SCREEN 3: HUB (MEDALL√ìN) --> <div id="screen-hub" class="screen bg-monument" > <div class="overlay" > <h2>TU MISI√ìN</h2> <p id="hub-instruction" >Toc√° un espacio vac√≠o para buscar ese fragmento.</p> <div class="medallion-container" > <div id="medallion-ring" class="medallion" > <div id="slot-Friso" class="fragment-slot slot-1" onclick="startMission('Friso')" > 1<br>El Friso </div> <div id="slot-Pampa" class="fragment-slot slot-2" onclick="startMission('Pampa')" > 2<br>Pampa </div> <div id="slot-Urna" class="fragment-slot slot-3" onclick="startMission('Urna')" > 3<br>Urna </div> <div style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 40px; opacity:0.3;" > ‚öì </div> </div> </div> <div id="status-text" >0/3 Fragmentos</div> <div id="final-message" > <button class="btn btn-final" onclick="startFinalMission()" >‚ú® ACTIVAR TORRE ‚ú®</button> <p style="font-size: 11px; margin-top: 5px; color: #FFD700;" >¬°Energ√≠a al m√°ximo !</p> </div> </div> </div> < !-- SCREEN 4: SUCCESS --> <div id="screen-success" class="screen bg-monument" > <div class="overlay" style="justify-content: center; align-items: center;" > <div style="background: rgba(117, 170, 219, 0.95); padding: 30px; border-radius: 20px; width: 85%; display: flex; flex-direction: column; align-items: center;" > <div style="font-size: 80px;" >‚ú®</div> <h1>¬°ENCONTRADO !</h1> <p id="success-msg" >Has recuperado un fragmento.</p> <div class="stars-container" id="success-stars" >‚≠ê‚≠ê‚≠ê</div> <div class="stars-label" >PUNTUACI√ìN</div> <div style="width: 80px; height: 80px; background: #D4AF37; border-radius: 50%; margin: 10px; display:flex; justify-content:center; align-items:center; font-size:30px; box-shadow: 0 0 30px white;" > ‚úì </div> <button class="btn btn-gold" style="margin-top: 20px;" onclick="showScreen('screen-hub')" >Volver al Medall√≥n</button> </div> </div> </div> < !-- SCREEN 5: FINAL WIN --> <div id="screen-final-win" class="screen bg-final" > <div class="fireworks" ></div> <div class="overlay" style="justify-content: center; align-items: center;" > <div style="background: rgba(0,0,0,0.6); padding: 30px; border-radius: 20px; width: 85%; display: flex; flex-direction: column; align-items: center;" > <div class="win-badge" >üá¶üá∑</div> <h1 style="font-size: 32px; color: #75AADB; -webkit-text-stroke: 1px white;" >¬°MISI√ìN CUMPLIDA ! </h1> <div id="final-score-display"
                style="font-size: 24px; color: #FFD700; margin: 10px 0; font-weight: bold; text-shadow: 0 2px 4px #000;" > --/9 Estrellas </div> <p style="font-size: 16px; margin-top: 10px;" >Has liberado la historia del Monumento.</p> <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; margin: 20px 0; border: 1px solid rgba(255,255,255,0.5);" > <p>üì∏ ¬°Mir√° la torre !</p> <small>Una bandera gigante flamea sobre ella.</small> </div> <button class="btn btn-gold" onclick="location.reload()" >Jugar de nuevo</button> </div> </div> </div> <script> // --- GAME STATE ---

                let gameState= {
                'Friso': false,
                    'Pampa': false,
                    'Urna': false
            }

            ;

            let missionScores= {
                'Friso': 0,
                    'Pampa': 0,
                    'Urna': 0
            }

            ;

            let currentMission='';
            let currentSessionScore=3;
            let arSceneReady=false;
            let currentTargetDetected=false;
            let detectionTimeout=null;

            const missionDetails= {
                'Friso': {
                    name: 'El Friso',
                        targetIndex: 0,
                        hint: 'Busca los bajorrelieves de piedra blanca en las paredes laterales'
                }

                ,
                'Pampa': {
                    name: 'La Pampa',
                        targetIndex: 1,
                        hint: 'Busca la escultura gigante con el buey de bronce'
                }

                ,
                'Urna': {
                    name: 'La Urna',
                        targetIndex: 2,
                        hint: 'Busca la Llama Votiva que arde eternamente'
                }

                ,
                'Final': {
                    name: 'La Gran Torre',
                        targetIndex: 3,
                        hint: 'Enfoca la Torre Central completa desde el patio'
                }
            }

            ;

            // --- AR INITIALIZATION ---
            document.addEventListener('DOMContentLoaded', function () {
                    const sceneEl=document.querySelector('a-scene');

                    if (sceneEl) {
                        sceneEl.addEventListener('loaded', function () {
                                console.log('A-Frame scene loaded');
                                arSceneReady=true;
                                document.getElementById('loading-screen').classList.add('hidden');
                            });

                        // Setup target detection listeners
                        setupARListeners();
                    }
                });

            function setupARListeners() {
                const targets=['friso',
                'pampa',
                'urna',
                'torre'];

                targets.forEach((targetName, index)=> {
                        const targetEl=document.getElementById(`target-$ {
                                targetName
                            }

                            `);

                        if (targetEl) {
                            targetEl.addEventListener('targetFound', ()=> {
                                    console.log(`Target found: $ {
                                            targetName
                                        }

                                        `);
                                    onTargetFound(targetName, index);
                                });

                            targetEl.addEventListener('targetLost', ()=> {
                                    console.log(`Target lost: $ {
                                            targetName
                                        }

                                        `);
                                    onTargetLost();
                                });
                        }
                    });
            }

            function onTargetFound(targetName, targetIndex) {
                // Check if this is the correct target for current mission
                const missionKey=currentMission;
                const expectedIndex=missionDetails[missionKey]?.targetIndex;

                if (targetIndex===expectedIndex) {
                    currentTargetDetected=true;
                    document.getElementById('ar-detection-status').classList.add('active');
                    document.getElementById('ar-confirm-btn').style.display='block';

                    // Auto-confirm after 2 seconds of stable detection
                    if (detectionTimeout) clearTimeout(detectionTimeout);

                    detectionTimeout=setTimeout(()=> {
                            if (currentTargetDetected) {
                                confirmFound();
                            }
                        }

                        , 2000);
                }
            }

            function onTargetLost() {
                currentTargetDetected=false;
                document.getElementById('ar-detection-status').classList.remove('active');
                document.getElementById('ar-confirm-btn').style.display='none';

                if (detectionTimeout) {
                    clearTimeout(detectionTimeout);
                    detectionTimeout=null;
                }
            }

            // --- SCREEN MANAGEMENT ---
            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s=> s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');

                if (screenId==='screen-hub') {
                    updateHubUI();
                }
            }

            function startMission(missionName) {
                if (gameState[missionName]) return;

                currentMission=missionName;
                currentSessionScore=3;
                currentTargetDetected=false;

                // Show AR
                document.getElementById('ar-scene-container').classList.add('active');
                document.getElementById('ar-overlay').classList.add('active');

                // Update UI
                document.getElementById('ar-mission-name').innerText=`Misi√≥n: $ {
                    missionDetails[missionName].name
                }

                `;
                document.getElementById('ar-mission-hint').innerText=missionDetails[missionName].hint;

                // Start MindAR
                const sceneEl=document.querySelector('a-scene');
                const arSystem=sceneEl.systems['mindar-image-system'];

                if (arSystem) {
                    arSystem.start();
                }
            }

            function startFinalMission() {
                currentMission='Final';
                currentTargetDetected=false;

                // Show AR
                document.getElementById('ar-scene-container').classList.add('active');
                document.getElementById('ar-overlay').classList.add('active');

                // Update UI
                document.getElementById('ar-mission-name').innerText="OBJETIVO FINAL";
                document.getElementById('ar-mission-hint').innerText=missionDetails['Final'].hint;

                // Start MindAR
                const sceneEl=document.querySelector('a-scene');
                const arSystem=sceneEl.systems['mindar-image-system'];

                if (arSystem) {
                    arSystem.start();
                }
            }

            function exitAR() {
                // Stop MindAR
                const sceneEl=document.querySelector('a-scene');
                const arSystem=sceneEl.systems['mindar-image-system'];

                if (arSystem) {
                    arSystem.stop();
                }

                // Hide AR
                document.getElementById('ar-scene-container').classList.remove('active');
                document.getElementById('ar-overlay').classList.remove('active');

                // Reset detection state
                currentTargetDetected=false;
                document.getElementById('ar-detection-status').classList.remove('active');
                document.getElementById('ar-confirm-btn').style.display='none';

                // Return to hub
                showScreen('screen-hub');
            }

            function confirmFound() {
                if (currentMission==='Final') {
                    exitAR();
                    showFinalWin();
                    return;
                }

                // Save state and score
                gameState[currentMission]=true;
                missionScores[currentMission]=currentSessionScore;

                // Update success screen
                document.getElementById('success-msg').innerText=`Has recuperado el fragmento de $ {
                    missionDetails[currentMission].name
                }

                .`;
                document.getElementById('success-stars').innerText=getStarsString(currentSessionScore);

                exitAR();
                showScreen('screen-success');
            }

            function showFinalWin() {
                let totalScore=0;
                Object.values(missionScores).forEach(score=> totalScore +=score);

                document.getElementById('final-score-display').innerText=`$ {
                    totalScore
                }

                /9 Estrellas`;
                showScreen('screen-final-win');
            }

            function updateHubUI() {
                let count=0;
                const total=3;

                for (const [key, done] of Object.entries(gameState)) {
                    const slot=document.getElementById(`slot-$ {
                            key
                        }

                        `);

                    if (done) {
                        slot.classList.add('slot-filled');
                        const stars=getStarsString(missionScores[key]);

                        slot.innerHTML=`‚úì<br>$ {
                            key
                        }

                        <div class="mini-stars">$ {
                            stars
                        }

                        </div>`;
                        count++;
                    }
                }

                const statusText=document.getElementById('status-text');

                statusText.innerText=`$ {
                    count
                }

                /$ {
                    total
                }

                Fragmentos`;

                if (count===total) {
                    document.getElementById('medallion-ring').classList.add('completed');
                    document.getElementById('hub-instruction').innerText="¬°Energ√≠a completa! Dir√≠gete al patio.";
                    document.getElementById('final-message').style.display='block';
                    statusText.style.color='#D4AF37';
                    statusText.style.fontWeight='bold';
                }
            }

            function getStarsString(count) {
                let s="";
                for (let i=0; i < count; i++) s+="‚≠ê";
                return s || "-";
            }

            </script></body></html>